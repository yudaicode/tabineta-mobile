# Supabase RLS セットアップガイド

## 概要

このガイドでは、Tabineta MobileアプリのSupabase Row Level Security (RLS) ポリシーを設定する手順を説明します。

## RLSとは？

Row Level Security (RLS) は、データベースレベルでのアクセス制御機構です。各テーブルに対して、誰がどのデータを読み書きできるかを細かく制御できます。

## セットアップ手順

### 1. Supabaseダッシュボードにログイン

1. [Supabase](https://supabase.com) にアクセス
2. プロジェクトを選択
3. 左サイドバーから「SQL Editor」をクリック

### 2. RLSポリシーSQLの実行

1. 「New Query」をクリック
2. `supabase/migrations/20250130_enable_rls_policies.sql` の内容を全てコピー
3. SQLエディタに貼り付け
4. 「Run」ボタンをクリック

### 3. 実行結果の確認

- エラーなく完了すれば成功です
- 「Success. No rows returned」のようなメッセージが表示されます

### 4. RLS有効化の確認

1. 左サイドバーから「Table Editor」を選択
2. 各テーブル（profiles, trip_schedules等）を選択
3. 右上の「...」メニューから「Edit table」を選択
4. 「Enable Row Level Security」がONになっていることを確認

### 5. ポリシーの確認

1. 左サイドバーから「Authentication」→「Policies」を選択
2. 各テーブルにポリシーが設定されていることを確認

## 設定されたポリシー一覧

### profiles（プロフィール）
- ✅ 全員が閲覧可能
- ✅ 自分のみ更新・削除可能

### trip_schedules（旅行記）
- ✅ 公開旅行記は全員が閲覧可能
- ✅ 非公開旅行記は作成者のみ閲覧可能
- ✅ 自分のみ作成・更新・削除可能

### day_schedules（日程）
- ✅ 対応する旅行記が閲覧可能なら日程も閲覧可能
- ✅ 自分の旅行記の日程のみ作成・更新・削除可能

### activities（アクティビティ）
- ✅ 対応する旅行記が閲覧可能ならアクティビティも閲覧可能
- ✅ 自分の旅行記のアクティビティのみ作成・更新・削除可能

### trip_comments（コメント）
- ✅ 公開旅行記のコメントは全員が閲覧可能
- ✅ ログインユーザーは公開旅行記にコメント可能
- ✅ 自分のコメントのみ更新・削除可能

### trip_likes（いいね）
- ✅ 全員が閲覧可能（カウント用）
- ✅ 自分のいいねのみ作成・削除可能

### trip_bookmarks（ブックマーク）
- ✅ 自分のブックマークのみ閲覧可能
- ✅ 自分のブックマークのみ作成・削除可能

### follows（フォロー）
- ✅ 全員が閲覧可能（カウント用）
- ✅ 自分のフォローのみ作成・削除可能

### notifications（通知）
- ✅ 自分宛の通知のみ閲覧可能
- ✅ 誰でも通知を作成可能
- ✅ 自分宛の通知のみ更新・削除可能

## トラブルシューティング

### エラー: "relation does not exist"
- テーブルが存在しません。先にテーブルを作成してください。

### エラー: "permission denied for schema public"
- データベースの権限が不足しています。Supabaseプロジェクトの所有者でログインしているか確認してください。

### エラー: "policy already exists"
- ポリシーが既に存在します。以下のSQLで既存ポリシーを削除してから再実行してください：

```sql
-- 既存ポリシーを全て削除（必要な場合のみ）
DROP POLICY IF EXISTS "profiles_select_policy" ON profiles;
DROP POLICY IF EXISTS "profiles_update_policy" ON profiles;
-- ... 他のポリシーも同様
```

## テスト方法

### 1. 認証なしでアクセス

Supabase APIを直接叩いて、認証なしでアクセスできないことを確認：

```bash
curl -X GET 'https://your-project.supabase.co/rest/v1/profiles' \
  -H "apikey: your-anon-key" \
  -H "Authorization: Bearer your-anon-key"
```

### 2. アプリからのテスト

1. アプリにログイン
2. 他ユーザーの非公開旅行記が見えないことを確認
3. 自分の旅行記のみ編集・削除できることを確認
4. 他ユーザーのコメントを削除できないことを確認

## セキュリティチェックリスト

- [ ] 全てのテーブルでRLSが有効化されている
- [ ] 各テーブルに適切なポリシーが設定されている
- [ ] 非公開データが他ユーザーから見えないことを確認
- [ ] 自分のデータのみ編集・削除できることを確認
- [ ] 公開データは全員が閲覧できることを確認

## 次のステップ

RLS設定が完了したら、次は以下を実施してください：

1. ✅ アプリ全体の手動テスト
2. ✅ プライバシーポリシー・利用規約の作成
3. ✅ ストアリスティングの準備

---

**重要**: RLSポリシーは一度設定したら、本番環境でも必ず有効化してください。これがないと、全てのユーザーが全てのデータにアクセスできてしまいます。
